<div class="bg-chat h-100 w-100">
@if (chat()!) {
  <div #scrollableDiv class="scroll-messages">
    @for (date of getSortedDates(); track $index) {
      @for (message of getSortedMessagesForDate(date); track message.id) {
        @if (message.type === "SYSTEM") {
          <div class="chat-date">{{ message.content }}</div>
        } @else {
          <div
            [attr.id]="'message-' + message.id"
            [class]="['message-box', isSelfMessage(message)? 'self': 'other',
                      chat()!.isGroupChat? 'group': 'single']"
            (contextmenu)="onRightClick($event, message)"
          >
            @if (chat()!.isGroupChat && !isSelfMessage(message)) {
              <span class="message-sender"
                    [style.color]="message?.senderId! | colorize"
                    (click)="onChatUserSelected(message?.senderId!)"
              >
                {{ getChatUserFullName(message.senderId!) }}
              </span>
            }
            @if (message.repliedMessage !== undefined) {
              <div class="reply-box d-flex align-items-center p-2 mb-1"
                (click)="scrollToRepliedMessage(message.repliedMessage.id)"
                [style.border-left-color]="message?.repliedMessage?.senderId! | colorize:!chat()!.isGroupChat:isSelfRepliedMessage(message)">
                <div class="flex-grow-1">
                  <div class="reply-title" [style.color]="message?.repliedMessage?.senderId! | colorize:!chat()!.isGroupChat:isSelfRepliedMessage(message)">
                    {{ getChatUserFullName(message?.repliedMessage?.senderId!) }}
                  </div>
                  <div class="reply-content text-truncate">
                    @if (message?.repliedMessage?.messageType == "TEXT") {
                      {{ message?.repliedMessage?.content?.content }}
                    } @else if (message?.repliedMessage?.messageType == "AUDIO") {
                      Audio
                    } @else {
                      Attachment
                    }
                  </div>
                </div>
              </div>
            }
            @if (message.type === "TEXT") {
              <div class="message-text d-flex flex-row justify-content-between">
              <span class="fs-6" style="padding-right: 4.5rem">
                {{ message.content }}
              </span>
                <small class="message-date">
                  {{ message.createdAt | date:'hh:mm a': 'local' }}
                  @if (isSelfMessage(message)) {
                    @if (message.state === 'SEEN' || isSelfChat()) {
                      <span>
                        <fa-icon icon="check" class="seen"></fa-icon>
                        <fa-icon icon="check" class="seen ml-neg"></fa-icon>
                      </span>
                    } @else {
                      <span>
                        <fa-icon icon="check"></fa-icon>
                      </span>
                    }
                  }
                </small>
              </div>
            } @else if (message.type === 'MEDIA') {
              @for (mediaRef of message.mediaListReferences; track mediaRef; let i = $index) {
                <div class="message-media">
                  <img width="200" class="cursor-pointer"
                       [src]="mediaRef | mediaUrl | async" alt=""
                       (click)="onImageClick(message, i)"
                  >
                  <div class="shadow-overlay cursor-pointer"></div>
                  <small class="message-date cursor-pointer">
                    {{ message.createdAt | date:'hh:mm a': 'local' }}
                    @if (isSelfMessage(message)) {
                      @if (message.state === 'SENT') {
                        <span>
                        <fa-icon icon="check" class=""></fa-icon>
                      </span>
                      } @else {
                        <span>
                        <fa-icon icon="check" class="seen"></fa-icon>
                        <fa-icon icon="check" class="seen ml-neg"></fa-icon>
                      </span>
                      }
                    }
                  </small>
                </div>
              }
            } @else {
              <div class="voice-message d-flex align-items-center justify-content-between">
                <div class="d-flex align-items-center gap-2 w-100">
                  <button class="play-btn" (click)="togglePlay(message)">
                    <fa-icon [icon]="isPlaying(message) ? 'pause' : 'play'"></fa-icon>
                  </button>

                  <div class="waveform" (click)="onSeek($event, message)">
                    <div class="progress-dot" [style.left.%]="getProgress(message) * 100"></div>
                  </div>

                  <small class="duration">{{ getRemainingDuration(message) }}</small>

                  <small class="message-date">
                    {{ message.createdAt | date:'hh:mm a': 'local' }}
                    @if (isSelfMessage(message)) {
                      @if (message.state === 'SEEN' || isSelfChat()) {
                        <span>
                          <fa-icon icon="check" class="seen"></fa-icon>
                          <fa-icon icon="check" class="seen ml-neg"></fa-icon>
                        </span>
                      } @else {
                        <span>
                          <fa-icon icon="check"></fa-icon>
                        </span>
                      }
                    }
                  </small>

                  <audio [id]="'audio-' + message.id"
                         [src]="message.mediaListReferences![0] | mediaUrl:true | async"
                          preload="metadata"></audio>
                </div>
              </div>
            }
          </div>
        }
      }
      <div class="chat-date">{{ date | relativeMessagesDate }}</div>
    }
  </div>
  @if (showContextMenu()) {
    <div class="context-menu"
         [ngStyle]="{ top: contextMenuPosition().y, left: contextMenuPosition().x }"
    >
      <ul>
        <li (click)="replyMessage()">
          <fa-icon icon="reply"></fa-icon>&nbsp;&nbsp;Reply
        </li>
        <li (click)="copyMessage()"><fa-icon [icon]="['far', 'copy']"></fa-icon>&nbsp;&nbsp;Copy</li>
        <div class="separator"></div>
        @if (!isSelfMessage(this.repliedMessage!)) {
          <li><fa-icon icon="right-to-bracket"></fa-icon>&nbsp;&nbsp;Reply privately</li>
        }
        <li><fa-icon icon="share"></fa-icon>&nbsp;&nbsp;Forward</li>
        <li><fa-icon [icon]="['far', 'star']"></fa-icon>&nbsp;&nbsp;Star</li>
        <li><fa-icon icon="thumbtack"></fa-icon>&nbsp;&nbsp;Pin</li>
        <li><fa-icon icon="trash"></fa-icon>&nbsp;&nbsp;Delete for me</li>
        <div class="separator"></div>
        <li><fa-icon [icon]="['far', 'check-square']"></fa-icon>&nbsp;&nbsp;Select</li>
        <li><fa-icon icon="share-square"></fa-icon>&nbsp;&nbsp;Share</li>
      </ul>
    </div>
  }
} @else {
  <div class="d-flex h-100 w-100">
    <div class="d-flex flex-column justify-content-center align-items-center h-100 w-100">
      <img src="/assets/images/wa_banner.png" alt="whatsapp-clone-icon" width="350px">
      <h2 class="pt-3 title">WhatsApp Clone Application</h2>
      <p class="title">...</p>
    </div>
  </div>
}
</div>
